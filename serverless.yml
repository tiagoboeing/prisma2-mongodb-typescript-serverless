service: sls-prisma2-typescript-mongodb
useDotEnv: true

provider:
  name: aws
  runtime: nodejs14.x
  stage: ${opt:stage, 'dev'}
  lambdaHashingVersion: "20201221"
  environment:
    NODE_PATH: .:/opt
    PRISMA_QUERY_ENGINE_BINARY: /opt/.prisma/client/query-engine-rhel-openssl-1.0.x

plugins:
  - serverless-webpack
  - serverless-offline

functions:
  index:
    handler: src/index.handler
    events:
      - http:
          path: /
          method: get
    layers:
      - { Ref: PrismaClientLambdaLayer }
      - { Ref: PrismaGeneratedLambdaLayer }

# Unfortunelly for Serverless Prisma need binary and Lambda don't have permissions to access this
# the workaround is to create layers with the binaries
# https://github.com/prisma/prisma/issues/5023
layers:
  prismaClient:
    path: .build/.webpack/@prisma/node_modules
    description: Prisma binaries and schema

  prismaGenerated:
    path: .build/.webpack/.prisma/node_modules
    description: Prisma binaries and schema


#   prismaRhel:
#     path: node_modules/.prisma/client/query-engine-rhel-openssl-1.0.x
#     description: Prisma Red Hat binary

resources:
  Outputs:
    PrismaLayerExport:
      Value:
        Ref: PrismaGeneratedLambdaLayer
      Export:
        Name: PrismaGeneratedLambdaLayer

package:
  individually: true

custom:
  webpack:
    keepOutputDirectory: true
    includeModules: true
